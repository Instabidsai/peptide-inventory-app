# Auto-Heal Report

**Date**: 2/26/2026, 8:19:55 AM
**Issues detected**: 10
**Claude Code ran**: Yes
**CC session**: Completed
**Post-fix tsc**: PASS
**Post-fix tests**: PASS
**Auto-pushed**: No

## Issues Detected

### auto_error

- **Auto Error (fallback): console_error: [app] Admin AI chat error: Edge function error (401)**: console_error: [app] Admin AI chat error: Edge function error (401)
- **Auto Error (fallback): fetch_error: HTTP 401 Unauthorized: /functions/v1/admin-ai-chat**: fetch_error: HTTP 401 Unauthorized: /functions/v1/admin-ai-chat
- **Auto Error (fallback): fetch_error: Fetch failed: Failed to fetch â€” https://mckkegmkpqdicudnfhor.supaba**: fetch_error: Fetch failed: Failed to fetch â€” https://mckkegmkpqdicudnfhor.supabase.co/functions/v1/invite-user
- **Auto Error (fallback): fetch_error: Fetch failed: Failed to fetch â€” https://mckkegmkpqdicudnfhor.supaba**: fetch_error: Fetch failed: Failed to fetch â€” https://mckkegmkpqdicudnfhor.supabase.co/functions/v1/notify-commission

### Test Failures

- **use-invite.test.ts > useInviteRep invokes invite-user edge function and toasts success**: AssertionError: expected false to be true // Object.is equality  Ignored nodes: comments, script, style [36m<html>[39m   [36m<head />[39m   [36m<body>[39m     [36m<div />[39m   [36m</body>[3
- **use-invite.test.ts > useInviteRep updates profile with parent_rep_id when provided**: AssertionError: expected false to be true // Object.is equality  Ignored nodes: comments, script, style [36m<html>[39m   [36m<head />[39m   [36m<body>[39m     [36m<div />[39m   [36m</body>[3
- **use-movements.test.ts > useCreateMovement throws when user is not authenticated**: AssertionError: expected false to be true // Object.is equality  Ignored nodes: comments, script, style [36m<html>[39m   [36m<head />[39m   [36m<body>[39m     [36m<div />[39m   [36m</body>[3
- **MerchantOnboarding.test.tsx > MerchantOnboarding "existing" path calls scrape-brand edge function on submit**: AssertionError: expected "spy" to be called with arguments: [ 'scrape-brand', { body: { â€¦(2) } } ][90m  Number of calls: [1m0[22m [39m  Ignored nodes: comments, script, style [36m<html>[39m   [
- **MerchantOnboarding.test.tsx > MerchantOnboarding "existing" path shows scraped preview after successful scrape**: Error: Unable to find an element with the text: We Found Your Brand. This could be because the text is broken up by multiple elements. In this case, you can provide a function for your text matcher to
- **MerchantOnboarding.test.tsx > MerchantOnboarding "existing" path shows scrape error on failure**: Error: Unable to find an element with the text: Firecrawl timeout. This could be because the text is broken up by multiple elements. In this case, you can provide a function for your text matcher to m

## Claude Code Output

```
All 6 test failures fixed across 3 files. Here's what was wrong and what I changed:

### File 1: `src/pages/merchant/__tests__/MerchantOnboarding.test.tsx` (3 failures)
**Root cause:** The inline supabase mock was missing `auth.getSession`. The component uses `invokeEdgeFunction()` which calls `supabase.auth.getSession()` before invoking the edge function. Without it, every scrape attempt threw "Cannot read properties of undefined (reading 'getSession')".
**Fix:** Added `auth: { getSession, getUser }` to the inline supabase mock.

### File 2: `src/hooks/__tests__/use-invite.test.ts` (2 failures)
**Root cause:** The `useInviteRep` hook was refactored from `supabase.functions.invoke('invite-user', ...)` to `supabase.rpc('invite_new_rep', ...)`, but the tests still used `setFunctionResponse` and asserted on `supabase.functions.invoke`.
**Fix:** Switched to `setRpcResponse('invite_new_rep', ...)` and assertions against `supabase.rpc`.

### File 3: `src/hooks/__tests__/use-movements.test.ts` (1 failure)
**Root cause:** The test mocked `supabase.auth.getUser` to return null user, but the actual hook checks `profile?.org_id` from the auth context (not `supabase.auth.getUser`). The auth context still had a valid profile with org_id.
**Fix:** Used `setAuthContext({ profile: { ...mockProfile, org_id: null } })` and updated the assertion to match the actual error message ("No organization found").
```

