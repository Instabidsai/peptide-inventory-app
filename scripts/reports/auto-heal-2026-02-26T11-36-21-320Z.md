# Auto-Heal Report

**Date**: 2/26/2026, 6:36:21 AM
**Issues detected**: 4
**Claude Code ran**: Yes
**CC session**: Completed
**Post-fix tsc**: PASS
**Post-fix tests**: PASS
**Auto-pushed**: No

## Issues Detected

### Auto-Captured Runtime Errors

- **Auto Error (fallback): fetch_error: Fetch failed: Failed to fetch â€” https://mckkegmkpqdicudnfhor.supaba**: fetch_error: Fetch failed: Failed to fetch â€” https://mckkegmkpqdicudnfhor.supabase.co/functions/v1/invite-user
- **Auto Error (fallback): console_error: [app] Partner AI chat error: Partner role required**: console_error: [app] Partner AI chat error: Partner role required
- **Auto Error (fallback): fetch_error: HTTP 403 Forbidden: /functions/v1/partner-ai-chat**: fetch_error: HTTP 403 Forbidden: /functions/v1/partner-ai-chat

### Test Failures

- **use-contacts.test.ts > useCreateContact shows error toast on failure**: AssertionError: expected false to be true // Object.is equality  Ignored nodes: comments, script, style [36m<html>[39m   [36m<head />[39m   [36m<body>[39m     [36m<div />[39m   [36m</body>[3

## Claude Code Output

```
All 4 issues fixed. Summary:

**1. Test failure** (`use-contacts.test.ts:115`) â€” `useCreateContact` was refactored to use `supabase.rpc('create_contact_for_org')` but the test still mocked `setMockResponse('contacts', ...)` for the old `.from('contacts').insert()` path. Changed to `setRpcResponse('create_contact_for_org', ...)`.

**2. invite-user fetch error** (`#/admin/reps`) â€” `supabase.functions.invoke()` makes direct cross-origin requests to Supabase, which fail with CORS when the function isn't deployed. Added the same Vite proxy pattern used by `partner-ai-chat`: in dev mode (`MODE === 'development'`), uses `fetch('/functions/v1/invite-user')` through the Vite proxy, with proper auth headers and error handling.

**3. partner-ai-chat 403** (`#/ai`) â€” The `/ai` route had no role guard, so `fulfillment` and `viewer` users could access it, but the edge function only allows `sales_rep`/`admin`/`staff`/`super_admin`. Added `RoleBasedRedirect allowedRoles={['admin', 'staff', 'sales_rep', 'super_admin']}` to the route.

**4. Verification** â€” `tsc --noEmit`: 0 errors. `vitest run`: 342/342 tests pass (31/31 files).
```

